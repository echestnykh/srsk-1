<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <script src="../js/color-init.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Материалы — Профиль гостя — ШРСК</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
</head>
<body class="bg-base-200 min-h-screen flex flex-col">

<div id="header-placeholder"></div>

<main class="container mx-auto px-4 py-6 flex-1">
    <!-- Заголовок -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold" data-i18n="nav_portal_materials">Материалы</h1>
            <p class="text-base-content/60 text-sm" data-i18n="portal_materials_desc">Тексты и гайды для гостевого портала</p>
        </div>
        <button class="btn btn-primary" onclick="openEditModal()" data-permission="edit_portal_materials">
            + <span data-i18n="add">Добавить</span>
        </button>
    </div>

    <!-- Список материалов -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-0">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="w-12"></th>
                            <th data-i18n="col_title">Заголовок</th>
                            <th data-i18n="col_slug">Slug</th>
                            <th data-i18n="col_order">Порядок</th>
                            <th data-i18n="col_status">Статус</th>
                            <th class="w-24"></th>
                        </tr>
                    </thead>
                    <tbody id="materialsTable">
                        <tr><td colspan="6" class="text-center py-8">
                            <span class="loading loading-spinner loading-md"></span>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<div id="footer-placeholder"></div>

<!-- Модалка редактирования -->
<dialog id="editModal" class="modal">
    <div class="modal-box max-w-3xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <h3 class="font-bold text-lg mb-4" id="modalTitle" data-i18n="portal_new_material">Новый материал</h3>

        <form id="editForm" onsubmit="saveMaterial(event)" class="space-y-4">
            <input type="hidden" name="id">

            <!-- Slug и иконка -->
            <div class="grid grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label"><span class="label-text">URL (slug)</span></label>
                    <input type="text" name="slug" class="input input-bordered" required pattern="[a-z0-9\-]+" placeholder="how-to-get-here">
                    <label class="label"><span class="label-text-alt">Латиница, цифры, дефисы</span></label>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text" data-i18n="col_icon">Иконка</span></label>
                    <select name="icon" class="select select-bordered">
                        <option value="book">Книга</option>
                        <option value="map">Карта</option>
                        <option value="clipboard">Список</option>
                        <option value="home">Дом</option>
                        <option value="currency">Валюта</option>
                        <option value="question">Вопрос</option>
                    </select>
                </div>
            </div>

            <!-- Порядок и публикация -->
            <div class="grid grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label"><span class="label-text" data-i18n="col_order">Порядок</span></label>
                    <input type="number" name="sort_order" class="input input-bordered" value="0">
                </div>
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" name="is_published" class="checkbox checkbox-primary">
                        <span class="label-text" data-i18n="published">Опубликовано</span>
                    </label>
                </div>
            </div>

            <!-- Заголовки -->
            <div class="form-control">
                <label class="label"><span class="label-text" data-i18n="col_title">Заголовок</span></label>
                <div class="grid grid-cols-3 gap-2">
                    <input type="text" name="title_ru" class="input input-bordered" placeholder="Русский" required>
                    <input type="text" name="title_en" class="input input-bordered" placeholder="English">
                    <input type="text" name="title_hi" class="input input-bordered" placeholder="हिंदी">
                </div>
            </div>

            <!-- Контент с табами -->
            <div class="form-control">
                <label class="label"><span class="label-text">Содержимое (HTML)</span></label>
                <div role="tablist" class="tabs tabs-bordered">
                    <button type="button" role="tab" class="tab tab-active" onclick="switchTab('ru')">Русский</button>
                    <button type="button" role="tab" class="tab" onclick="switchTab('en')">English</button>
                    <button type="button" role="tab" class="tab" onclick="switchTab('hi')">हिंदी</button>
                </div>
                <div class="mt-2">
                    <div class="flex items-center gap-2 mb-2">
                        <button type="button" class="btn btn-xs btn-ghost" onclick="triggerImageUpload()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span data-i18n="insert_image">Вставить изображение</span>
                        </button>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    </div>
                    <textarea name="content_ru" class="textarea textarea-bordered w-full h-48 font-mono text-sm" placeholder="<h2>Заголовок</h2><p>Текст...</p>"></textarea>
                    <textarea name="content_en" class="textarea textarea-bordered w-full h-48 font-mono text-sm hidden" placeholder="<h2>Title</h2><p>Text...</p>"></textarea>
                    <textarea name="content_hi" class="textarea textarea-bordered w-full h-48 font-mono text-sm hidden" placeholder="<h2>शीर्षक</h2><p>पाठ...</p>"></textarea>
                </div>
                <label class="label"><span class="label-text-alt">HTML: &lt;h2&gt;, &lt;h3&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;li&gt;, &lt;a&gt;, &lt;strong&gt;, &lt;img&gt;</span></label>
            </div>

            <div class="modal-action">
                <button type="button" class="btn" onclick="editModal.close()" data-i18n="cancel">Отмена</button>
                <button type="submit" class="btn btn-primary" data-i18n="save">Сохранить</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<script src="../js/config.js"></script>
<script src="../js/cache.js"></script>
<script src="../js/utils.js"></script>
<script src="../js/layout.js"></script>

<script>
const t = key => Layout.t(key);
let materials = [];
let editingId = null;
let currentTab = 'ru';

async function init() {
    await Layout.init({
        module: 'portal',
        menuId: 'portal_content',
        itemId: 'portal_materials'
    });

    Layout.showLoader();
    await loadMaterials();
    Layout.hideLoader();
}

async function loadMaterials() {
    const { data, error } = await Layout.db
        .from('materials')
        .select('*')
        .order('sort_order');

    if (error) {
        Layout.handleError(error, 'Загрузка материалов');
        return;
    }

    materials = data || [];
    renderTable();
}

function renderTable() {
    const tbody = document.getElementById('materialsTable');

    if (materials.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-base-content/50">
            <span data-i18n="no_materials">Материалов пока нет</span>
        </td></tr>`;
        return;
    }

    tbody.innerHTML = materials.map(m => `
        <tr class="${m.is_published ? '' : 'opacity-50'}">
            <td>${getIcon(m.icon)}</td>
            <td>
                <div class="font-medium">${Layout.escapeHtml(Layout.getName(m) || m.title_ru || 'Без названия')}</div>
            </td>
            <td class="text-base-content/60 font-mono text-sm">${Layout.escapeHtml(m.slug)}</td>
            <td>${m.sort_order}</td>
            <td>
                <span class="badge ${m.is_published ? 'badge-success' : 'badge-ghost'}" data-i18n="${m.is_published ? 'published' : 'hidden'}">
                    ${m.is_published ? 'Опубликован' : 'Скрыт'}
                </span>
            </td>
            <td>
                <div class="flex gap-1">
                    <button class="btn btn-ghost btn-sm btn-square" onclick="togglePublished('${m.id}', ${!m.is_published})" title="${m.is_published ? 'Скрыть' : 'Опубликовать'}">
                        ${m.is_published
                            ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>'
                            : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>'
                        }
                    </button>
                    <button class="btn btn-ghost btn-sm btn-square" onclick="openEditModal('${m.id}')" title="Редактировать">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </button>
                    <button class="btn btn-ghost btn-sm btn-square text-error" onclick="deleteMaterial('${m.id}')" title="Удалить">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function openEditModal(id = null) {
    editingId = id;
    const form = document.getElementById('editForm');
    form.reset();
    currentTab = 'ru';
    switchTab('ru');

    if (id) {
        const m = materials.find(x => x.id === id);
        if (m) {
            document.getElementById('modalTitle').textContent = t('edit');
            form.elements.id.value = m.id;
            form.elements.slug.value = m.slug || '';
            form.elements.icon.value = m.icon || 'book';
            form.elements.sort_order.value = m.sort_order || 0;
            form.elements.is_published.checked = m.is_published;
            form.elements.title_ru.value = m.title_ru || '';
            form.elements.title_en.value = m.title_en || '';
            form.elements.title_hi.value = m.title_hi || '';
            form.elements.content_ru.value = m.content_ru || '';
            form.elements.content_en.value = m.content_en || '';
            form.elements.content_hi.value = m.content_hi || '';
        }
    } else {
        document.getElementById('modalTitle').textContent = t('portal_new_material');
    }

    editModal.showModal();
}

function switchTab(lang) {
    currentTab = lang;

    // Обновляем табы
    document.querySelectorAll('[role="tab"]').forEach(tab => {
        tab.classList.remove('tab-active');
    });
    event.target.classList.add('tab-active');

    // Показываем нужный textarea
    document.querySelectorAll('textarea[name^="content_"]').forEach(el => {
        el.classList.add('hidden');
    });
    document.querySelector(`textarea[name="content_${lang}"]`).classList.remove('hidden');
}

function triggerImageUpload() {
    document.getElementById('imageInput').click();
}

async function handleImageUpload(input) {
    if (!input.files || !input.files[0]) return;

    const file = input.files[0];

    if (file.size > 5 * 1024 * 1024) {
        Layout.showNotification('Файл слишком большой (макс. 5MB)', 'error');
        return;
    }

    Layout.showLoader();

    const materialId = editingId || 'temp_' + Date.now();
    const ext = file.name.split('.').pop();
    const fileName = `${Date.now()}.${ext}`;
    const filePath = `${materialId}/${fileName}`;

    const { error: uploadError } = await Layout.db.storage
        .from('materials')
        .upload(filePath, file, { cacheControl: '3600', upsert: false });

    Layout.hideLoader();

    if (uploadError) {
        Layout.showNotification('Ошибка загрузки: ' + uploadError.message, 'error');
        return;
    }

    const { data: { publicUrl } } = Layout.db.storage
        .from('materials')
        .getPublicUrl(filePath);

    // Вставляем img тег в активный textarea
    const textarea = document.querySelector(`textarea[name="content_${currentTab}"]`);
    const imgTag = `<img src="${publicUrl}" alt="" style="max-width: 100%; height: auto; margin: 1rem 0;">`;

    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    textarea.value = text.substring(0, start) + imgTag + text.substring(end);
    textarea.focus();
    textarea.setSelectionRange(start + imgTag.length, start + imgTag.length);

    Layout.showNotification(t('saved'), 'success');
    input.value = '';
}

async function saveMaterial(e) {
    e.preventDefault();

    const form = e.target;
    const data = {
        slug: form.elements.slug.value.trim(),
        icon: form.elements.icon.value,
        sort_order: parseInt(form.elements.sort_order.value) || 0,
        is_published: form.elements.is_published.checked,
        title_ru: form.elements.title_ru.value.trim(),
        title_en: form.elements.title_en.value.trim(),
        title_hi: form.elements.title_hi.value.trim(),
        content_ru: form.elements.content_ru.value,
        content_en: form.elements.content_en.value,
        content_hi: form.elements.content_hi.value
    };

    if (!data.slug || !data.title_ru) {
        Layout.showNotification('Заполните обязательные поля', 'warning');
        return;
    }

    Layout.showLoader();

    let result;
    if (editingId) {
        data.updated_at = new Date().toISOString();
        result = await Layout.db.from('materials').update(data).eq('id', editingId);
    } else {
        result = await Layout.db.from('materials').insert(data);
    }

    Layout.hideLoader();

    if (result.error) {
        Layout.handleError(result.error, 'Сохранение');
        return;
    }

    Layout.showNotification(t('saved'), 'success');
    editModal.close();
    await loadMaterials();
}

async function togglePublished(id, isPublished) {
    const { error } = await Layout.db
        .from('materials')
        .update({ is_published: isPublished, updated_at: new Date().toISOString() })
        .eq('id', id);

    if (error) {
        Layout.handleError(error, 'Обновление статуса');
        return;
    }

    const m = materials.find(x => x.id === id);
    if (m) m.is_published = isPublished;
    renderTable();
    Layout.showNotification(isPublished ? 'Опубликовано' : 'Скрыто', 'success');
}

async function deleteMaterial(id) {
    if (!confirm(t('confirm_delete'))) return;

    Layout.showLoader();
    const { error } = await Layout.db.from('materials').delete().eq('id', id);
    Layout.hideLoader();

    if (error) {
        Layout.handleError(error, 'Удаление');
        return;
    }

    Layout.showNotification(t('deleted'), 'success');
    await loadMaterials();
}

function getIcon(name) {
    const icons = {
        'map': '<svg class="w-5 h-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>',
        'book': '<svg class="w-5 h-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>',
        'clipboard': '<svg class="w-5 h-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>',
        'home': '<svg class="w-5 h-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>',
        'currency': '<svg class="w-5 h-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
        'question': '<svg class="w-5 h-5 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
    };
    return icons[name] || icons['book'];
}

init();
</script>
</body>
</html>
