<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шахматка — ШРСК</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { theme: { extend: { screens: { 'desktop': '1200px' } } } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        /* Основная таблица */
        .timeline-table {
            border-collapse: collapse;
            table-layout: fixed;
        }

        .timeline-table th,
        .timeline-table td {
            padding: 0;
            height: 32px;
            vertical-align: middle;
        }

        /* Границы: светлые внутри дня, тёмные между днями */
        .timeline-table th,
        .timeline-table td {
            border: 1px solid #e5e7eb; /* светлая по умолчанию */
        }

        /* Тёмная граница слева у первой половины дня (начало дня) */
        .day-start {
            border-left: 2px solid #9ca3af !important;
        }

        /* Ширина ячейки = половина дня */
        .half-day {
            width: 24px;
            min-width: 24px;
            max-width: 24px;
        }

        /* Левая колонка - закреплена */
        .sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            width: 160px;
            min-width: 160px;
            padding: 0 12px;
            text-align: left;
            white-space: nowrap;
            border-right: 2px solid #9ca3af !important;
        }

        /* Заголовок таблицы - закреплён сверху */
        .timeline-table thead {
            position: sticky;
            top: 0;
            z-index: 15;
        }

        .timeline-table thead th {
            background: #f3f4f6;
        }

        .timeline-table thead th.sticky-col {
            z-index: 20;
            background: #f3f4f6;
        }

        /* Строка с числами */
        .row-dates th {
            font-weight: 600;
            font-size: 13px;
            text-align: center;
        }

        /* Строка с днями недели */
        .row-weekdays th {
            font-weight: 400;
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
            text-align: center;
        }

        /* Строка ретритов */
        .row-retreats th {
            background: #f9fafb;
            height: 34px;
            padding: 3px !important;
        }

        .retreat-bar {
            display: block;
            background: #10b981;
            color: white;
            font-size: 14px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 26px;
            line-height: 18px;
        }

        /* Заголовок здания */
        .row-building td {
            background: #d1d5db !important;
            font-weight: 600;
            font-size: 14px;
        }

        .row-building .sticky-col {
            background: #d1d5db !important;
            cursor: pointer;
            user-select: none;
        }

        .row-building .sticky-col:hover {
            background: #c0c5cc !important;
        }

        /* Заголовок номера */
        .row-room td {
            background: #e5e7eb !important;
            font-weight: 500;
            font-size: 13px;
        }

        .row-room .sticky-col {
            background: #e5e7eb !important;
            cursor: pointer;
            user-select: none;
            padding-left: 20px;
        }

        .row-room .sticky-col:hover {
            background: #d6d9dc !important;
        }

        /* Строка места */
        .row-bed .sticky-col {
            padding-left: 36px;
            font-size: 13px;
            color: #374151;
        }

        /* Полоска гостя */
        .guest-bar {
            background: #fef08a;
            border: 1px solid #facc15;
            height: 24px;
            margin: 3px 2px;
            border-radius: 4px;
            font-size: 11px;
            padding: 0 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
        }

        /* Выходные дни */
        .weekend {
            background: #fef2f2 !important;
        }

        /* Сегодня */
        .today {
            background: #dbeafe !important;
        }

        /* Скрытые строки (свёрнутые) */
        .collapsed {
            display: none;
        }

        /* Калибровочная строка - всегда видима, но без высоты */
        .row-calibration {
            height: 0 !important;
            visibility: collapse;
        }
        .row-calibration td {
            height: 0 !important;
            padding: 0 !important;
            border: none !important;
        }

        /* Стрелка сворачивания */
        .toggle-arrow {
            display: inline-block;
            width: 16px;
            transition: transform 0.2s;
        }

        .toggle-arrow.collapsed {
            transform: rotate(-90deg);
        }

        /* Пустые ячейки кликабельны */
        .row-bed td.clickable {
            cursor: pointer;
        }
        .row-bed td.clickable:hover {
            background: #e0f2fe !important;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

    <div id="header-placeholder"></div>

    <main class="px-4 py-6">
        <!-- Заголовок страницы -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">Шахматка</h1>
        </div>

        <!-- Контейнер таблицы -->
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="timeline-table" id="timelineTable">
                <!-- Генерируется через JS -->
            </table>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- Модалка действий -->
    <dialog id="actionModal" class="modal">
        <div class="modal-box max-w-lg">
            <!-- Экран 1: Выбор действия -->
            <div id="actionScreen">
                <h3 class="font-bold text-lg mb-4">Действие</h3>

                <!-- Информация о месте -->
                <div class="text-sm text-gray-500 mb-4" id="modalLocation"></div>

                <!-- Даты -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Заезд</span>
                        </label>
                        <input type="date" id="modalCheckIn" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Выезд</span>
                        </label>
                        <input type="date" id="modalCheckOut" class="input input-bordered" />
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="grid grid-cols-2 gap-3">
                    <button class="btn btn-primary" onclick="showCheckinForm()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        Заселить
                    </button>
                    <button class="btn btn-info" onclick="showBookingForm()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Забронировать
                    </button>
                    <button class="btn btn-warning" onclick="handleAction('cleaning')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        Уборка
                    </button>
                    <button class="btn btn-error" onclick="handleAction('repair')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        Закрыть на ремонт
                    </button>
                </div>

                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn">Отмена</button>
                    </form>
                </div>
            </div>

            <!-- Экран 2: Форма заселения -->
            <div id="checkinScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showActionScreen()">←</button>
                    <h3 class="font-bold text-lg">Заселение</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4" id="checkinLocation"></div>

                <form id="checkinForm" onsubmit="saveCheckin(event)">
                    <!-- Категория -->
                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text font-medium">Категория</span>
                        </label>
                        <select name="category_id" id="checkinCategory" class="select select-bordered w-full">
                            <option value="">—</option>
                        </select>
                    </div>

                    <!-- Выбор из команды -->
                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text font-medium">Член команды</span>
                        </label>
                        <select name="team_member_id" id="checkinTeamMember" class="select select-bordered w-full" onchange="toggleGuestFields()">
                            <option value="">— Гость (ввести имя ниже) —</option>
                        </select>
                    </div>

                    <!-- Данные гостя -->
                    <div id="guestFields">
                        <div class="divider text-sm opacity-60">Или данные гостя</div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Имя</span>
                                </label>
                                <input type="text" name="guest_name" id="checkinGuestName" class="input input-bordered input-sm w-full" />
                            </div>
                            <div class="form-control">
                                <label class="label py-1">
                                    <span class="label-text">Телефон</span>
                                </label>
                                <input type="tel" name="guest_phone" class="input input-bordered input-sm w-full" />
                            </div>
                        </div>
                    </div>

                    <!-- Даты -->
                    <div class="divider text-sm opacity-60"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Заезд</span>
                            </label>
                            <input type="date" name="check_in" id="checkinDateIn" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="early_checkin" class="checkbox checkbox-sm checkbox-primary" />
                                <span class="label-text text-sm">Ранний заезд</span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Выезд</span>
                            </label>
                            <input type="date" name="check_out" id="checkinDateOut" class="input input-bordered input-sm w-full" />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="late_checkout" class="checkbox checkbox-sm checkbox-primary" />
                                <span class="label-text text-sm">Поздний выезд</span>
                            </label>
                        </div>
                    </div>

                    <!-- Примечания -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text">Примечания</span>
                        </label>
                        <textarea name="notes" rows="2" class="textarea textarea-bordered textarea-sm w-full"></textarea>
                    </div>

                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="showActionScreen()">Назад</button>
                        <button type="submit" class="btn btn-primary">Заселить</button>
                    </div>
                </form>
            </div>

            <!-- Экран 3: Форма бронирования -->
            <div id="bookingScreen" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <button class="btn btn-ghost btn-sm btn-circle" onclick="showActionScreen()">←</button>
                    <h3 class="font-bold text-lg">Бронирование</h3>
                </div>

                <div class="text-sm text-gray-500 mb-4" id="bookingLocation"></div>

                <form id="bookingForm" onsubmit="saveBooking(event)">
                    <!-- Название брони -->
                    <div class="form-control mb-3">
                        <label class="label py-1">
                            <span class="label-text font-medium">Название брони</span>
                        </label>
                        <input type="text" name="name" class="input input-bordered input-sm w-full" placeholder="Например: Группа из Москвы" />
                    </div>

                    <!-- Контакт -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Контактное лицо</span>
                            </label>
                            <input type="text" name="contact_name" class="input input-bordered input-sm w-full" required />
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Телефон</span>
                            </label>
                            <input type="tel" name="contact_phone" class="input input-bordered input-sm w-full" />
                        </div>
                    </div>

                    <!-- Даты -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Заезд</span>
                            </label>
                            <input type="date" name="check_in" id="bookingDateIn" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="early_checkin" class="checkbox checkbox-sm checkbox-info" />
                                <span class="label-text text-sm">Ранний заезд</span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text font-medium">Выезд</span>
                            </label>
                            <input type="date" name="check_out" id="bookingDateOut" class="input input-bordered input-sm w-full" required />
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" name="late_checkout" class="checkbox checkbox-sm checkbox-info" />
                                <span class="label-text text-sm">Поздний выезд</span>
                            </label>
                        </div>
                    </div>

                    <!-- Количество мест -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text font-medium">Количество мест</span>
                        </label>
                        <input type="number" name="beds_count" min="1" value="1" class="input input-bordered input-sm w-full" required />
                    </div>

                    <!-- Примечания -->
                    <div class="form-control mt-3">
                        <label class="label py-1">
                            <span class="label-text">Примечания</span>
                        </label>
                        <textarea name="notes" rows="2" class="textarea textarea-bordered textarea-sm w-full"></textarea>
                    </div>

                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="showActionScreen()">Назад</button>
                        <button type="submit" class="btn btn-info">Забронировать</button>
                    </div>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script src="../js/layout.js"></script>
    <script>
        // Конфигурация
        const DAYS_TO_SHOW = 90; // 3 месяца
        const CELL_WIDTH = 24;   // ширина половины дня

        // Состояние сворачивания
        const collapsedBuildings = new Set();
        const collapsedRooms = new Set();

        // Данные из БД
        let timelineData = {
            retreats: [],
            buildings: []
        };

        // Справочники для форм
        let categories = [];
        let teamMembers = [];

        // Базовая дата (сегодня)
        const baseDate = new Date();
        baseDate.setHours(0, 0, 0, 0);

        // Преобразовать дату в dayIndex относительно baseDate
        function dateToDayIndex(dateStr) {
            const date = new Date(dateStr);
            date.setHours(0, 0, 0, 0);
            const diff = date - baseDate;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        // Загрузка данных из БД
        async function loadTimelineData() {
            const endDate = new Date(baseDate);
            endDate.setDate(endDate.getDate() + DAYS_TO_SHOW);
            const startDateStr = baseDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];

            // Загружаем параллельно
            const [buildingsRes, roomsRes, residentsRes, retreatsRes] = await Promise.all([
                Layout.db.from('buildings')
                    .select('*, building_types(id, slug, color, name_ru, name_en, name_hi)')
                    .eq('is_active', true)
                    .order('sort_order'),
                Layout.db.from('rooms')
                    .select('*')
                    .eq('is_active', true)
                    .order('building_id')
                    .order('floor')
                    .order('number'),
                Layout.db.from('residents')
                    .select(`*,
                        resident_categories(id, name_ru, name_en, name_hi, color),
                        team_members(id, first_name, last_name, spiritual_name),
                        bookings(id, name, contact_name)`)
                    .eq('status', 'active')
                    .lte('check_in', endDateStr)
                    .or(`check_out.is.null,check_out.gte.${startDateStr}`),
                Layout.db.from('retreats')
                    .select('*')
                    .lte('start_date', endDateStr)
                    .gte('end_date', startDateStr)
                    .order('start_date')
            ]);

            const buildings = buildingsRes.data || [];
            const rooms = roomsRes.data || [];
            const residents = residentsRes.data || [];
            const retreats = retreatsRes.data || [];

            // Преобразуем ретриты
            timelineData.retreats = retreats.map(r => {
                const rawStartDay = dateToDayIndex(r.start_date);
                const rawEndDay = dateToDayIndex(r.end_date);
                return {
                    name: Layout.getName(r),
                    startDay: Math.max(0, rawStartDay),
                    endDay: Math.min(DAYS_TO_SHOW - 1, rawEndDay),
                    rawStartDay,
                    rawEndDay
                };
            }).filter(r => r.rawStartDay <= DAYS_TO_SHOW - 1 && r.rawEndDay >= 0);

            // Группируем комнаты по зданиям
            const roomsByBuilding = {};
            rooms.forEach(room => {
                if (!roomsByBuilding[room.building_id]) {
                    roomsByBuilding[room.building_id] = [];
                }
                roomsByBuilding[room.building_id].push(room);
            });

            // Группируем резидентов по комнатам
            const residentsByRoom = {};
            residents.forEach(res => {
                if (!residentsByRoom[res.room_id]) {
                    residentsByRoom[res.room_id] = [];
                }
                residentsByRoom[res.room_id].push(res);
            });

            // Формируем структуру данных
            timelineData.buildings = buildings.map(building => {
                const buildingRooms = roomsByBuilding[building.id] || [];

                return {
                    id: building.id,
                    name: Layout.getName(building),
                    rooms: buildingRooms.map(room => {
                        const capacity = room.capacity || 1;
                        const roomResidents = residentsByRoom[room.id] || [];

                        // Создаём виртуальные места
                        const beds = [];
                        for (let i = 0; i < capacity; i++) {
                            beds.push({
                                name: capacity === 1 ? '' : `${i + 1}`,
                                roomId: room.id,
                                bedIndex: i,
                                guests: []
                            });
                        }

                        // Распределяем резидентов по местам
                        // Сортируем по дате заселения
                        roomResidents.sort((a, b) => new Date(a.check_in) - new Date(b.check_in));

                        roomResidents.forEach(res => {
                            const startDay = Math.max(0, dateToDayIndex(res.check_in));
                            const endDay = res.check_out
                                ? Math.min(DAYS_TO_SHOW - 1, dateToDayIndex(res.check_out))
                                : DAYS_TO_SHOW - 1;

                            if (startDay > DAYS_TO_SHOW - 1 || endDay < 0) return;

                            // Получаем имя резидента
                            let guestName = res.guest_name || '';
                            if (res.team_members) {
                                const tm = res.team_members;
                                guestName = tm.spiritual_name || `${tm.first_name} ${tm.last_name}`.trim();
                            }
                            // Если это бронирование - показываем название брони или имя контакта
                            if (!guestName && res.bookings) {
                                guestName = res.bookings.name || res.bookings.contact_name || '';
                            }

                            // Получаем цвет категории
                            const category = res.resident_categories;
                            const color = category?.color || '#fef08a';
                            // Делаем border темнее
                            const border = color;

                            // Ранний заезд = обе половины дня заезда (startHalf = 0)
                            // Обычный заезд = только вторая половина (startHalf = 1)
                            // Поздний выезд = обе половины дня выезда (endHalf = 1)
                            // Обычный выезд = только первая половина (endHalf = 0)
                            let startHalf = res.early_checkin === true ? 0 : 1;
                            let endHalf = res.late_checkout === true ? 1 : 0;

                            // Если заезд и выезд в один день, корректируем чтобы span был минимум 1
                            if (startDay === endDay && startHalf > endHalf) {
                                // Показываем хотя бы одну половину
                                endHalf = startHalf;
                            }

                            const guest = {
                                id: res.id,
                                name: guestName || '—',
                                startDay,
                                startHalf,
                                endDay,
                                endHalf,
                                color,
                                border
                            };

                            // Ищем свободное место для этого периода
                            let placed = false;
                            for (const bed of beds) {
                                const hasOverlap = bed.guests.some(g => {
                                    const gStart = g.startDay * 2 + g.startHalf;
                                    const gEnd = g.endDay * 2 + g.endHalf;
                                    const rStart = guest.startDay * 2 + guest.startHalf;
                                    const rEnd = guest.endDay * 2 + guest.endHalf;
                                    return !(rEnd < gStart || rStart > gEnd);
                                });

                                if (!hasOverlap) {
                                    bed.guests.push(guest);
                                    placed = true;
                                    break;
                                }
                            }

                            // Если не нашли место, добавляем в первое (будет визуальное наложение)
                            if (!placed && beds.length > 0) {
                                beds[0].guests.push(guest);
                            }
                        });

                        return {
                            id: room.id,
                            name: room.number,
                            beds
                        };
                    })
                };
            }).filter(b => b.rooms.length > 0);
        }

        // Получить дату для дня
        function getDateForDay(dayIndex) {
            const date = new Date(baseDate);
            date.setDate(baseDate.getDate() + dayIndex);
            return date;
        }

        // Проверка выходного
        function isWeekend(dayIndex) {
            const date = getDateForDay(dayIndex);
            const day = date.getDay();
            return day === 0 || day === 6;
        }

        // Получить день недели
        function getWeekdayName(dayIndex) {
            const days = ['вс', 'пн', 'вт', 'ср', 'чт', 'пт', 'сб'];
            const date = getDateForDay(dayIndex);
            return days[date.getDay()];
        }

        // Переключить сворачивание здания
        function toggleBuilding(buildingId) {
            if (collapsedBuildings.has(buildingId)) {
                collapsedBuildings.delete(buildingId);
            } else {
                collapsedBuildings.add(buildingId);
            }
            renderTable();
        }

        // Переключить сворачивание номера
        function toggleRoom(roomId) {
            if (collapsedRooms.has(roomId)) {
                collapsedRooms.delete(roomId);
            } else {
                collapsedRooms.add(roomId);
            }
            renderTable();
        }

        // Текущий контекст модалки
        let modalContext = null;

        // Форматировать дату для input[type="date"]
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Открыть модалку действий
        function openActionModal(dayIndex, roomId, buildingName, roomName, bedName) {
            const checkInDate = getDateForDay(dayIndex);
            const checkOutDate = getDateForDay(dayIndex + 1);

            // Сохраняем контекст
            modalContext = { dayIndex, roomId, buildingName, roomName, bedName };

            // Заполняем поля
            const location = bedName
                ? `${buildingName} → ${roomName} → Место ${bedName}`
                : `${buildingName} → ${roomName}`;
            document.getElementById('modalLocation').textContent = location;
            document.getElementById('modalCheckIn').value = formatDateForInput(checkInDate);
            document.getElementById('modalCheckOut').value = formatDateForInput(checkOutDate);

            // Открываем модалку
            document.getElementById('actionModal').showModal();
        }

        // Загрузка справочников
        async function loadDictionaries() {
            const [catRes, teamRes] = await Promise.all([
                Layout.db.from('resident_categories').select('*').order('sort_order'),
                Layout.db.from('team_members').select('*').order('spiritual_name')
            ]);
            categories = catRes.data || [];
            teamMembers = teamRes.data || [];

            // Заполняем селекты
            const catSelect = document.getElementById('checkinCategory');
            catSelect.innerHTML = '<option value="">—</option>' +
                categories.map(c => `<option value="${c.id}">${Layout.getName(c)}</option>`).join('');

            const teamSelect = document.getElementById('checkinTeamMember');
            teamSelect.innerHTML = '<option value="">— Гость (ввести имя ниже) —</option>' +
                teamMembers.map(t => {
                    const name = t.spiritual_name || `${t.first_name} ${t.last_name}`.trim();
                    return `<option value="${t.id}">${name}</option>`;
                }).join('');
        }

        // Переключение экранов
        function showActionScreen() {
            document.getElementById('actionScreen').classList.remove('hidden');
            document.getElementById('checkinScreen').classList.add('hidden');
            document.getElementById('bookingScreen').classList.add('hidden');
        }

        function showCheckinForm() {
            document.getElementById('actionScreen').classList.add('hidden');
            document.getElementById('checkinScreen').classList.remove('hidden');
            document.getElementById('bookingScreen').classList.add('hidden');

            // Копируем данные
            document.getElementById('checkinLocation').textContent =
                document.getElementById('modalLocation').textContent;
            document.getElementById('checkinDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('checkinDateOut').value =
                document.getElementById('modalCheckOut').value;

            // Сбрасываем форму
            document.getElementById('checkinForm').reset();
            document.getElementById('checkinDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('checkinDateOut').value =
                document.getElementById('modalCheckOut').value;
            toggleGuestFields();
        }

        function showBookingForm() {
            document.getElementById('actionScreen').classList.add('hidden');
            document.getElementById('checkinScreen').classList.add('hidden');
            document.getElementById('bookingScreen').classList.remove('hidden');

            // Копируем данные
            document.getElementById('bookingLocation').textContent =
                document.getElementById('modalLocation').textContent;
            document.getElementById('bookingDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('bookingDateOut').value =
                document.getElementById('modalCheckOut').value;

            // Сбрасываем форму
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingDateIn').value =
                document.getElementById('modalCheckIn').value;
            document.getElementById('bookingDateOut').value =
                document.getElementById('modalCheckOut').value;
        }

        // Переключение полей гостя
        function toggleGuestFields() {
            const teamMemberId = document.getElementById('checkinTeamMember').value;
            const guestFields = document.getElementById('guestFields');
            if (teamMemberId) {
                guestFields.classList.add('hidden');
                document.getElementById('checkinGuestName').value = '';
            } else {
                guestFields.classList.remove('hidden');
            }
        }

        // Сохранение заселения
        async function saveCheckin(e) {
            e.preventDefault();
            const form = e.target;

            const data = {
                room_id: modalContext.roomId,
                category_id: form.category_id.value || null,
                team_member_id: form.team_member_id.value || null,
                guest_name: form.guest_name.value || null,
                guest_phone: form.guest_phone?.value || null,
                check_in: form.check_in.value,
                check_out: form.check_out.value || null,
                early_checkin: form.early_checkin.checked,
                late_checkout: form.late_checkout.checked,
                notes: form.notes.value || null,
                status: 'active'
            };

            // Проверка: должен быть либо член команды, либо имя гостя
            if (!data.team_member_id && !data.guest_name) {
                alert('Укажите члена команды или введите имя гостя');
                return;
            }

            const { error } = await Layout.db.from('residents').insert(data);

            if (error) {
                console.error('Error saving checkin:', error);
                alert('Ошибка при заселении: ' + error.message);
                return;
            }

            document.getElementById('actionModal').close();
            showActionScreen();
            await loadTimelineData();
            renderTable();
        }

        // Сохранение бронирования
        async function saveBooking(e) {
            e.preventDefault();
            const form = e.target;

            const bedsCount = parseInt(form.beds_count.value) || 1;

            // Создаём бронирование
            const earlyCheckin = form.early_checkin.checked;
            const lateCheckout = form.late_checkout.checked;
            const bookingName = form.name.value.trim() || null;

            const bookingData = {
                name: bookingName,
                contact_name: form.contact_name.value,
                contact_phone: form.contact_phone.value || null,
                check_in: form.check_in.value,
                check_out: form.check_out.value,
                beds_count: bedsCount,
                early_checkin: earlyCheckin,
                late_checkout: lateCheckout,
                notes: form.notes.value || null,
                status: 'confirmed'
            };

            const { data: booking, error: bookingError } = await Layout.db
                .from('bookings')
                .insert(bookingData)
                .select()
                .single();

            if (bookingError) {
                console.error('Error saving booking:', bookingError);
                alert('Ошибка при бронировании: ' + bookingError.message);
                return;
            }

            // Создаём placeholder резидентов для бронирования
            const residents = [];
            for (let i = 0; i < bedsCount; i++) {
                residents.push({
                    room_id: modalContext.roomId,
                    booking_id: booking.id,
                    check_in: form.check_in.value,
                    check_out: form.check_out.value,
                    early_checkin: earlyCheckin,
                    late_checkout: lateCheckout,
                    status: 'active'
                });
            }

            const { error: residentsError } = await Layout.db.from('residents').insert(residents);

            if (residentsError) {
                console.error('Error saving booking residents:', residentsError);
            }

            document.getElementById('actionModal').close();
            showActionScreen();
            await loadTimelineData();
            renderTable();
        }

        // Обработчик других действий
        function handleAction(action) {
            const checkIn = document.getElementById('modalCheckIn').value;
            const checkOut = document.getElementById('modalCheckOut').value;

            console.log('Action:', action);
            console.log('Context:', modalContext);
            console.log('Check-in:', checkIn);
            console.log('Check-out:', checkOut);

            // Закрываем модалку
            document.getElementById('actionModal').close();

            // TODO: Уборка и ремонт
        }

        // Рендер таблицы
        function renderTable() {
            const table = document.getElementById('timelineTable');

            let html = '<thead>';

            // Строка ретритов
            html += '<tr class="row-retreats"><th class="sticky-col"></th>';
            const renderedRetreats = new Set();
            let col = 0;
            while (col < DAYS_TO_SHOW * 2) {
                const dayIndex = Math.floor(col / 2);
                const isFirstHalf = col % 2 === 0;
                const dayStart = isFirstHalf ? 'day-start' : '';

                // Ищем ретрит, который начинается на этой колонке
                const retreat = timelineData.retreats.find(r =>
                    !renderedRetreats.has(r.name) && r.startDay === dayIndex && isFirstHalf
                );

                if (retreat) {
                    renderedRetreats.add(retreat.name);
                    const span = (retreat.endDay - retreat.startDay + 1) * 2;
                    html += `<th colspan="${span}" class="text-left ${dayStart}"><span class="retreat-bar">${retreat.name}</span></th>`;
                    col += span;
                } else {
                    // Проверяем, находимся ли внутри уже отрендеренного ретрита
                    const insideRetreat = timelineData.retreats.some(r => {
                        const startCol = r.startDay * 2;
                        const endCol = (r.endDay + 1) * 2 - 1;
                        return col > startCol && col <= endCol;
                    });
                    if (!insideRetreat) {
                        html += `<th class="${dayStart}"></th>`;
                    }
                    col++;
                }
            }
            html += '</tr>';

            // Строка с числами
            html += '<tr class="row-dates"><th class="sticky-col"></th>';
            for (let day = 0; day < DAYS_TO_SHOW; day++) {
                const date = getDateForDay(day);
                const weekend = isWeekend(day) ? 'weekend' : '';
                const today = day === 0 ? 'today' : '';
                html += `<th colspan="2" class="day-start ${weekend} ${today}">${date.getDate()}</th>`;
            }
            html += '</tr>';

            // Строка с днями недели
            html += '<tr class="row-weekdays"><th class="sticky-col"></th>';
            for (let day = 0; day < DAYS_TO_SHOW; day++) {
                const weekend = isWeekend(day) ? 'weekend' : '';
                const today = day === 0 ? 'today' : '';
                html += `<th colspan="2" class="day-start ${weekend} ${today}">${getWeekdayName(day)}</th>`;
            }
            html += '</tr>';

            html += '</thead><tbody>';

            // Калибровочная строка для фиксации ширины колонок
            html += '<tr class="row-calibration"><td class="sticky-col"></td>';
            for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                html += '<td class="half-day"></td>';
            }
            html += '</tr>';

            // Здания
            timelineData.buildings.forEach(building => {
                const buildingCollapsed = collapsedBuildings.has(building.id);
                const arrowClass = buildingCollapsed ? 'collapsed' : '';

                // Заголовок здания
                html += `<tr class="row-building">`;
                html += `<td class="sticky-col" onclick="toggleBuilding('${building.id}')">`;
                html += `<span class="toggle-arrow ${arrowClass}">▼</span> ${building.name}</td>`;
                for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                    const dayIndex = Math.floor(col / 2);
                    const isFirstHalf = col % 2 === 0;
                    const dayStart = isFirstHalf ? 'day-start' : '';
                    html += `<td class="${dayStart}"></td>`;
                }
                html += '</tr>';

                // Номера (скрыты если здание свёрнуто)
                building.rooms.forEach(room => {
                    const roomCollapsed = collapsedRooms.has(room.id);
                    const roomArrowClass = roomCollapsed ? 'collapsed' : '';
                    const hiddenClass = buildingCollapsed ? 'collapsed' : '';

                    // Заголовок номера
                    html += `<tr class="row-room ${hiddenClass}">`;
                    html += `<td class="sticky-col" onclick="toggleRoom('${room.id}')">`;
                    html += `<span class="toggle-arrow ${roomArrowClass}">▼</span> Номер ${room.name}</td>`;
                    for (let col = 0; col < DAYS_TO_SHOW * 2; col++) {
                        const dayIndex = Math.floor(col / 2);
                        const isFirstHalf = col % 2 === 0;
                        const dayStart = isFirstHalf ? 'day-start' : '';
                        html += `<td class="${dayStart}"></td>`;
                    }
                    html += '</tr>';

                    // Места (скрыты если здание или номер свёрнуты)
                    const bedsHiddenClass = (buildingCollapsed || roomCollapsed) ? 'collapsed' : '';

                    room.beds.forEach(bed => {
                        const bedLabel = bed.name ? `Место ${bed.name}` : '';
                        html += `<tr class="row-bed ${bedsHiddenClass}"><td class="sticky-col">${bedLabel}</td>`;

                        // Ячейки для каждой половины дня
                        let col = 0;
                        while (col < DAYS_TO_SHOW * 2) {
                            const dayIndex = Math.floor(col / 2);
                            const halfIndex = col % 2;
                            const isFirstHalf = halfIndex === 0;
                            const dayStart = isFirstHalf ? 'day-start' : '';

                            // Проверяем есть ли гость начинающийся здесь
                            const guest = bed.guests.find(g =>
                                g.startDay === dayIndex && g.startHalf === halfIndex
                            );

                            if (guest) {
                                const startCol = guest.startDay * 2 + guest.startHalf;
                                const endCol = guest.endDay * 2 + guest.endHalf;
                                const span = Math.max(1, endCol - startCol + 1); // минимум 1 ячейка

                                const bgColor = guest.color || '#fef08a';
                                const borderColor = guest.border || '#facc15';

                                html += `<td colspan="${span}" class="${dayStart}" style="padding: 0;">`;
                                html += `<div class="guest-bar" style="background: ${bgColor}; border-color: ${borderColor};">${guest.name}</div>`;
                                html += '</td>';
                                col += span;
                            } else {
                                const insideGuest = bed.guests.some(g => {
                                    const startCol = g.startDay * 2 + g.startHalf;
                                    const endCol = g.endDay * 2 + g.endHalf;
                                    return col > startCol && col <= endCol;
                                });

                                if (!insideGuest) {
                                    const weekend = isWeekend(dayIndex) ? 'weekend' : '';
                                    const today = dayIndex === 0 ? 'today' : '';
                                    // Экранируем кавычки в именах
                                    const bName = building.name.replace(/'/g, "\\'");
                                    const rName = room.name.replace(/'/g, "\\'");
                                    const bedName = bed.name.replace(/'/g, "\\'");
                                    html += `<td class="half-day clickable ${dayStart} ${weekend} ${today}" onclick="openActionModal(${dayIndex}, '${room.id}', '${bName}', '${rName}', '${bedName}')"></td>`;
                                }
                                col++;
                            }
                        }

                        html += '</tr>';
                    });
                });
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        // Инициализация
        async function init() {
            await Layout.init({ module: 'housing', menuId: 'housing', itemId: 'timeline' });
            await Promise.all([
                loadTimelineData(),
                loadDictionaries()
            ]);
            renderTable();
        }

        init();
    </script>
</body>
</html>
