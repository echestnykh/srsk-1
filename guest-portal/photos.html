<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è ‚Äî –®–†–°–ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Portal CSS -->
    <link rel="stylesheet" href="css/portal.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'srsk-green': '#147D30',
                        'srsk-orange': '#FFBA47',
                        'srsk-bg': '#F5F3EF',
                    },
                    fontFamily: {
                        'sans': ['Noto Sans', 'Noto Sans Devanagari', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Sans', 'Noto Sans Devanagari', sans-serif;
        }
        .photo-card {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            background: #f0f0f0;
        }
        .photo-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .photo-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-card .photo-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 10;
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #147D30;
        }
        .photo-card.selected {
            outline: 4px solid #147D30;
            outline-offset: -4px;
        }
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            align-items: center;
            justify-content: center;
        }
        .lightbox.active {
            display: flex;
        }
        .lightbox img {
            max-width: 90%;
            max-height: 90vh;
            object-fit: contain;
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 1001;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transition: all 0.2s;
        }
        .lightbox-close:hover {
            background: rgba(255,255,255,0.2);
        }
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            cursor: pointer;
            z-index: 1001;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transition: all 0.2s;
            user-select: none;
        }
        .lightbox-nav:hover {
            background: rgba(255,255,255,0.2);
        }
        .lightbox-prev {
            left: 20px;
        }
        .lightbox-next {
            right: 20px;
        }
        .day-section {
            scroll-margin-top: 100px;
        }
    </style>
</head>
<body class="bg-srsk-bg min-h-screen">

    <!-- –®–∞–ø–∫–∞ -->
    <header class="bg-srsk-green sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="text-white text-xl font-semibold">‚Üê –ù–∞–∑–∞–¥</a>
                <h1 class="text-white text-lg font-medium" id="pageTitle">–§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è</h1>
                <div class="w-20"></div> <!-- Spacer for centering -->
            </div>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8 py-8">

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="mb-8 bg-white rounded-2xl shadow-sm p-6">
            <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ—Ç—Ä–∏—Ç—É -->
                <div class="flex-1 w-full md:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–†–µ—Ç—Ä–∏—Ç</label>
                    <select id="retreatFilter" class="w-full px-4 py-3 bg-white rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-srsk-green">
                        <option value="all">–í—Å–µ —Ä–µ—Ç—Ä–∏—Ç—ã</option>
                    </select>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–Ω—é -->
                <div class="flex-1 w-full md:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–î–µ–Ω—å</label>
                    <select id="dayFilter" class="w-full px-4 py-3 bg-white rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-srsk-green">
                        <option value="all">–í—Å–µ –¥–Ω–∏</option>
                    </select>
                </div>

                <!-- –ß–µ–∫–±–æ–∫—Å "–§–æ—Ç–æ —Å–æ –º–Ω–æ–π" -->
                <div class="flex items-end h-full pt-7">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="myPhotosOnly" class="w-5 h-5 text-srsk-green rounded border-gray-300 focus:ring-srsk-green">
                        <span class="text-sm font-medium text-gray-700">–§–æ—Ç–æ —Å–æ –º–Ω–æ–π</span>
                        <span id="myPhotosCount" class="text-xs text-gray-500 hidden"></span>
                    </label>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–π—Ç–∏ —Å–µ–±—è" -->
            <div id="searchFaceSection" class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">–ù–∞–π–¥–∏—Ç–µ —Å–µ–±—è –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è—Ö</h3>
                        <p class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ—ë —Ñ–æ—Ç–æ, –∏ AI –Ω–∞–π–¥—ë—Ç –≤—Å–µ —Å–Ω–∏–º–∫–∏ —Å –≤–∞–º–∏</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="file" id="selfieInput" accept="image/jpeg,image/jpg,image/png" class="hidden">
                        <button id="findMeBtn" class="px-6 py-3 bg-srsk-green text-white rounded-xl font-medium hover:bg-green-700 transition-colors whitespace-nowrap flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            –ù–∞–π—Ç–∏ —Å–µ–±—è
                        </button>
                    </div>
                </div>
                <!-- –°—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞ -->
                <div id="searchStatus" class="hidden mt-4 p-4 rounded-xl bg-blue-50 border border-blue-200">
                    <div class="flex items-center gap-3">
                        <div id="searchStatusSpinner" class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <div id="searchStatusCheck" class="hidden w-6 h-6 text-green-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <span class="text-sm text-blue-800" id="searchStatusText">–ü–æ–∏—Å–∫...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—á—ë—Ç—á–∏–∫ —Ñ–æ—Ç–æ –∏ –ø–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ -->
        <div class="mb-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div id="photoCount" class="text-gray-600">
                <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JS -->
            </div>
            <!-- –ü–∞–Ω–µ–ª—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ -->
            <div id="selectionPanel" class="hidden flex items-center gap-3">
                <span id="selectedCount" class="text-sm font-medium text-gray-700">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                <button id="selectAllBtn" class="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </button>
                <button id="downloadSelectedBtn" class="px-4 py-2 text-sm bg-srsk-green text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    –°–∫–∞—á–∞—Ç—å ZIP
                </button>
            </div>
        </div>

        <!-- –ì–∞–ª–µ—Ä–µ—è –ø–æ –¥–Ω—è–º -->
        <div id="galleryContainer">
            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JS -->
        </div>

        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div id="emptyState" class="hidden text-center py-20">
            <div class="text-6xl mb-4">üì∏</div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">–ü–æ–∫–∞ –Ω–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</h2>
            <p class="text-gray-600">–§–æ—Ç–æ —Å —Ä–µ—Ç—Ä–∏—Ç–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å, –∫–æ–≥–¥–∞ –∏—Ö –∑–∞–≥—Ä—É–∑–∏—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ</p>
        </div>

        <!-- Loader -->
        <div id="loader" class="text-center py-20">
            <div class="inline-block w-12 h-12 border-4 border-gray-200 border-t-srsk-green rounded-full animate-spin"></div>
            <p class="mt-4 text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π...</p>
        </div>

    </main>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <span class="lightbox-prev lightbox-nav" onclick="navigateLightbox(-1)">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </span>
        <img id="lightboxImg" src="" alt="">
        <span class="lightbox-next lightbox-nav" onclick="navigateLightbox(1)">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </span>
        <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-4">
            <button id="downloadBtn" type="button" class="px-6 py-3 bg-white text-gray-800 rounded-xl font-medium hover:bg-gray-100 transition-colors flex items-center gap-2 cursor-pointer">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                –°–∫–∞—á–∞—Ç—å
            </button>
        </div>
    </div>

    <!-- JSZip –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/portal-config.js"></script>
    <script src="js/portal-auth.js"></script>

    <script>
        // ==================== STATE ====================
        let allPhotos = [];
        let myPhotos = []; // –§–æ—Ç–æ –≥–¥–µ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–æ–∫–∞ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, –±—É–¥–µ—Ç –≤ –§–∞–∑–µ 2)
        let filteredPhotos = [];
        let currentPhotoIndex = 0;
        let retreats = [];
        let currentRetreatFilter = 'all';
        let currentDayFilter = 'all';
        let showMyPhotosOnly = false;
        let selectedPhotoIds = new Set(); // –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

        // ==================== INIT ====================
        async function init() {
            // Check auth first
            const guest = await PortalAuth.checkGuestAuth();

            if (!guest) {
                // checkGuestAuth already redirects to login
                return;
            }

            // Load user's retreats
            await loadRetreats();
        }

        async function loadRetreats() {
            const supabase = window.portalSupabase;
            if (!supabase) {
                console.error('Supabase client not initialized');
                showEmpty();
                return;
            }

            const currentUser = window.currentGuest;
            if (!currentUser || !currentUser.id) {
                console.error('Current user not found');
                showEmpty();
                return;
            }

            // Get retreat IDs where user is registered
            const { data: registrations, error: regError } = await supabase
                .from('retreat_registrations')
                .select('retreat_id')
                .eq('vaishnava_id', currentUser.id)
                .in('status', ['guest', 'team']);

            if (regError) {
                console.error('Error loading registrations:', regError);
                showEmpty();
                return;
            }

            if (!registrations || registrations.length === 0) {
                showEmpty();
                return;
            }

            const retreatIds = registrations.map(r => r.retreat_id);

            // Load retreat details
            const { data: retreatsData, error: retreatsError } = await supabase
                .from('retreats')
                .select('id, name_ru, name_en, name_hi, start_date, end_date')
                .in('id', retreatIds)
                .order('start_date', { ascending: false });

            if (retreatsError) {
                console.error('Error loading retreats:', retreatsError);
                showEmpty();
                return;
            }

            retreats = retreatsData || [];

            if (retreats.length === 0) {
                showEmpty();
                return;
            }

            // Load all photos from all user's retreats
            await loadAllPhotos();
        }

        async function loadAllPhotos() {
            const supabase = window.portalSupabase;
            if (!supabase) {
                console.error('Supabase client not initialized');
                showEmpty();
                return;
            }

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');

            const retreatIds = retreats.map(r => r.id);

            // Load all photos (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ retreats)
            const { data, error } = await supabase
                .from('retreat_photos')
                .select('*')
                .in('retreat_id', retreatIds)
                .eq('index_status', 'indexed')
                .order('uploaded_at', { ascending: false });

            document.getElementById('loader').classList.add('hidden');

            if (error) {
                console.error('Error loading photos:', error);
                showEmpty();
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Ç—Ä–∏—Ç–µ –∏–∑ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ retreats
            allPhotos = (data || []).map(photo => {
                const retreat = retreats.find(r => r.id === photo.retreat_id);
                return {
                    ...photo,
                    retreat_name_ru: retreat?.name_ru,
                    retreat_name_en: retreat?.name_en,
                    retreat_name_hi: retreat?.name_hi
                };
            });

            if (allPhotos.length === 0) {
                showEmpty();
                return;
            }

            // Load my photos (with face tags)
            const currentUser = window.currentGuest;
            if (currentUser && currentUser.id) {
                const { data: myPhotoData } = await supabase
                    .from('face_tags')
                    .select('photo_id')
                    .eq('vaishnava_id', currentUser.id);

                myPhotos = myPhotoData?.map(t => t.photo_id) || [];

                console.log('My photos loaded:', myPhotos.length);
            }

            renderFilters();
            applyFilters();
        }

        function showEmpty() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('galleryContainer').innerHTML = '';
            document.getElementById('photoCount').textContent = '';
        }

        function renderFilters() {
            const lang = localStorage.getItem('language') || 'ru';

            // Retreat filter
            const retreatFilter = document.getElementById('retreatFilter');
            retreatFilter.innerHTML = '<option value="all">–í—Å–µ —Ä–µ—Ç—Ä–∏—Ç—ã</option>' +
                retreats.map(r => {
                    const name = r[`name_${lang}`] || r.name_ru;
                    return `<option value="${r.id}">${name}</option>`;
                }).join('');

            retreatFilter.addEventListener('change', (e) => {
                currentRetreatFilter = e.target.value;
                applyFilters();
            });

            // Day filter - will be populated after filtering by retreat
            const dayFilterSelect = document.getElementById('dayFilter');
            dayFilterSelect.addEventListener('change', (e) => {
                currentDayFilter = e.target.value;
                applyFilters();
            });

            // My photos checkbox
            const myPhotosCheckbox = document.getElementById('myPhotosOnly');
            myPhotosCheckbox.addEventListener('change', (e) => {
                showMyPhotosOnly = e.target.checked;
                applyFilters();
            });

            // Update my photos count
            if (myPhotos.length > 0) {
                document.getElementById('myPhotosCount').textContent = `(${myPhotos.length})`;
                document.getElementById('myPhotosCount').classList.remove('hidden');
            } else {
                myPhotosCheckbox.disabled = true;
                myPhotosCheckbox.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function applyFilters() {
            let photos = [...allPhotos];

            // Filter by retreat
            if (currentRetreatFilter !== 'all') {
                photos = photos.filter(p => p.retreat_id === currentRetreatFilter);
            }

            // Filter by my photos
            if (showMyPhotosOnly && myPhotos.length > 0) {
                photos = photos.filter(p => myPhotos.includes(p.id));
            }

            // Update day filter options based on current photos
            updateDayFilter(photos);

            // Filter by day
            if (currentDayFilter !== 'all') {
                const dayNum = parseInt(currentDayFilter);
                photos = photos.filter(p => (p.day_number || 0) === dayNum);
            }

            // Sort: my photos first, then by date
            photos.sort((a, b) => {
                const aIsMine = myPhotos.includes(a.id);
                const bIsMine = myPhotos.includes(b.id);

                if (aIsMine && !bIsMine) return -1;
                if (!aIsMine && bIsMine) return 1;

                // Both mine or both not mine - sort by date
                return new Date(b.uploaded_at) - new Date(a.uploaded_at);
            });

            filteredPhotos = photos;

            if (filteredPhotos.length === 0) {
                showEmpty();
            } else {
                renderGallery();
            }
        }

        function updateDayFilter(photos) {
            const days = [...new Set(photos.map(p => p.day_number || 0))].sort((a, b) => a - b);
            const dayFilterSelect = document.getElementById('dayFilter');

            dayFilterSelect.innerHTML = '<option value="all">–í—Å–µ –¥–Ω–∏</option>' +
                days.map(day => {
                    const label = day == 0 ? '–ë–µ–∑ –¥–∞—Ç—ã' : `–î–µ–Ω—å ${day}`;
                    const count = photos.filter(p => (p.day_number || 0) === day).length;
                    return `<option value="${day}">${label} (${count})</option>`;
                }).join('');
        }

        function renderGallery() {
            document.getElementById('emptyState').classList.add('hidden');

            // Group by day and retreat
            const photosByDay = {};
            filteredPhotos.forEach(photo => {
                const day = photo.day_number || 0;
                if (!photosByDay[day]) photosByDay[day] = [];
                photosByDay[day].push(photo);
            });

            const days = Object.keys(photosByDay).sort((a, b) => a - b);

            // Photo count
            const myCount = filteredPhotos.filter(p => myPhotos.includes(p.id)).length;
            const countText = myCount > 0
                ? `–í—Å–µ–≥–æ: ${filteredPhotos.length} (—Å –≤–∞–º–∏: ${myCount})`
                : `–í—Å–µ–≥–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: ${filteredPhotos.length}`;
            document.getElementById('photoCount').textContent = countText;

            // Render gallery
            const container = document.getElementById('galleryContainer');
            const lang = localStorage.getItem('language') || 'ru';

            container.innerHTML = days.map(day => {
                const dayPhotos = photosByDay[day];
                const label = day == 0 ? '–ë–µ–∑ –¥–∞—Ç—ã' : `–î–µ–Ω—å ${day}`;

                return `
                    <div id="day-${day}" class="day-section mb-12">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">${label}</h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            ${dayPhotos.map(photo => {
                                const globalIdx = filteredPhotos.indexOf(photo);
                                const url = getPhotoUrl(photo.storage_path);
                                const thumbUrl = getPhotoUrl(photo.thumb_path || photo.storage_path);
                                const isMine = myPhotos.includes(photo.id);
                                const retreatName = photo[`retreat_name_${lang}`] || photo.retreat_name_ru || '';

                                const isSelected = selectedPhotoIds.has(photo.id);
                                return `
                                    <div class="photo-card ${isMine ? 'ring-4 ring-srsk-orange' : ''} ${isSelected ? 'selected' : ''}">
                                        <input type="checkbox" class="photo-checkbox" data-photo-id="${photo.id}" ${isSelected ? 'checked' : ''}
                                               onclick="event.stopPropagation(); togglePhotoSelection('${photo.id}')">
                                        <img src="${thumbUrl}" alt="Photo" loading="lazy" onclick="openLightbox(${globalIdx})">
                                        ${isMine ? '<div class="absolute top-2 right-2 bg-srsk-orange text-white text-xs px-2 py-1 rounded-full">–í—ã</div>' : ''}
                                        ${currentRetreatFilter === 'all' && retreatName ? `<div class="absolute bottom-2 left-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded truncate">${retreatName}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Update selection UI after render
            updateSelectionUI();
        }

        function getPhotoUrl(storagePath) {
            const supabase = window.portalSupabase;
            if (!supabase) return '';

            const { data } = supabase.storage
                .from('retreat-photos')
                .getPublicUrl(storagePath);
            return data.publicUrl;
        }

        function scrollToDay(dayId) {
            if (dayId === 'all') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                document.getElementById(dayId).scrollIntoView({ behavior: 'smooth' });
            }
        }

        // ==================== LIGHTBOX ====================
        function openLightbox(index) {
            currentPhotoIndex = index;
            updateLightbox();
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }

        function navigateLightbox(direction) {
            currentPhotoIndex += direction;
            if (currentPhotoIndex < 0) currentPhotoIndex = filteredPhotos.length - 1;
            if (currentPhotoIndex >= filteredPhotos.length) currentPhotoIndex = 0;
            updateLightbox();
        }

        function updateLightbox() {
            const photo = filteredPhotos[currentPhotoIndex];
            const url = getPhotoUrl(photo.storage_path);
            const filename = photo.storage_path.split('/').pop();

            document.getElementById('lightboxImg').src = url;

            // –£–¥–∞–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã href –∏ download, –∏—Å–ø–æ–ª—å–∑—É–µ–º onclick
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.removeAttribute('href');
            downloadBtn.removeAttribute('download');
            downloadBtn.onclick = () => downloadPhotoFile(url, filename);
        }

        async function downloadPhotoFile(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
                URL.revokeObjectURL(blobUrl);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            }
        }

        // ==================== MULTIPLE SELECTION ====================
        function togglePhotoSelection(photoId) {
            if (selectedPhotoIds.has(photoId)) {
                selectedPhotoIds.delete(photoId);
            } else {
                selectedPhotoIds.add(photoId);
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedPhotoIds.size;
            document.getElementById('selectedCount').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;

            const panel = document.getElementById('selectionPanel');
            const downloadBtn = document.getElementById('downloadSelectedBtn');

            if (count > 0) {
                panel.classList.remove('hidden');
                downloadBtn.disabled = false;
            } else {
                panel.classList.add('hidden');
                downloadBtn.disabled = true;
            }

            // Update checkboxes state
            document.querySelectorAll('.photo-checkbox').forEach(checkbox => {
                const photoId = checkbox.dataset.photoId;
                checkbox.checked = selectedPhotoIds.has(photoId);
                const card = checkbox.closest('.photo-card');
                card.classList.toggle('selected', selectedPhotoIds.has(photoId));
            });

            // Update select all button
            const selectAllBtn = document.getElementById('selectAllBtn');
            const allSelected = filteredPhotos.length > 0 && filteredPhotos.every(p => selectedPhotoIds.has(p.id));
            selectAllBtn.textContent = allSelected ? '–°–Ω—è—Ç—å –≤—ã–±–æ—Ä' : '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
        }

        function selectAllPhotos() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const allSelected = filteredPhotos.every(p => selectedPhotoIds.has(p.id));

            if (allSelected) {
                // Deselect all
                filteredPhotos.forEach(p => selectedPhotoIds.delete(p.id));
            } else {
                // Select all filtered
                filteredPhotos.forEach(p => selectedPhotoIds.add(p.id));
            }

            updateSelectionUI();
        }

        async function downloadSelectedAsZip() {
            if (selectedPhotoIds.size === 0) return;

            const btn = document.getElementById('downloadSelectedBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';

            try {
                const zip = new JSZip();
                const selectedPhotos = allPhotos.filter(p => selectedPhotoIds.has(p.id));

                // Download photos and add to zip
                let processed = 0;
                for (const photo of selectedPhotos) {
                    try {
                        const url = getPhotoUrl(photo.storage_path);
                        const response = await fetch(url);
                        const blob = await response.blob();
                        const filename = photo.storage_path.split('/').pop();

                        zip.file(filename, blob);
                        processed++;

                        btn.innerHTML = `<span class="loading loading-spinner loading-sm"></span> ${processed}/${selectedPhotos.length}`;
                    } catch (error) {
                        console.error('Failed to download photo:', photo.id, error);
                    }
                }

                btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';

                // Generate zip file
                const zipBlob = await zip.generateAsync({ type: 'blob' });

                // Download zip
                const zipUrl = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = zipUrl;
                a.download = `photos-${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(zipUrl);

                // Clear selection
                selectedPhotoIds.clear();
                updateSelectionUI();

            } catch (error) {
                console.error('Error creating ZIP:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ==================== FACE SEARCH ====================
        async function findMyPhotos() {
            const currentUser = window.currentGuest;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
            if (currentUser?.photoUrl) {
                console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è:', currentUser.photoUrl);
                await searchFaceByUrl(currentUser.photoUrl);
            } else {
                // –ù–µ—Ç —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è - –ø—Ä–æ—Å–∏–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–ª—Ñ–∏
                console.log('–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∑–∞–ø—Ä–æ—Å —Å–µ–ª—Ñ–∏');
                document.getElementById('selfieInput').click();
            }
        }

        async function searchFaceByUrl(photoUrl) {
            const supabase = window.portalSupabase;
            const currentUser = window.currentGuest;

            if (!supabase || !currentUser) {
                alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                return;
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
            const statusDiv = document.getElementById('searchStatus');
            const statusText = document.getElementById('searchStatusText');
            const statusSpinner = document.getElementById('searchStatusSpinner');
            const statusCheck = document.getElementById('searchStatusCheck');
            statusDiv.classList.remove('hidden');
            statusText.textContent = '–ü–æ–∏—Å–∫ –ª–∏—Ü...';
            statusSpinner.classList.remove('hidden');
            statusCheck.classList.add('hidden');

            try {
                const retreatIds = retreats.map(r => r.id);
                let allFoundPhotoIds = new Set();

                for (const retreatId of retreatIds) {
                    try {
                        const { data: searchResult, error: searchError } = await supabase.functions.invoke(
                            'search-face',
                            {
                                body: {
                                    retreat_id: retreatId,
                                    vaishnava_id: currentUser.id,
                                    threshold: 80
                                }
                            }
                        );

                        if (searchError) {
                            console.error('Search error for retreat:', retreatId, searchError);
                            continue;
                        }

                        if (searchResult?.matched_photo_ids) {
                            searchResult.matched_photo_ids.forEach(id => allFoundPhotoIds.add(id));
                        }
                    } catch (err) {
                        console.error('Error searching retreat:', retreatId, err);
                    }
                }

                // –û–±–Ω–æ–≤–∏—Ç—å myPhotos –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                myPhotos = Array.from(allFoundPhotoIds);

                if (myPhotos.length === 0) {
                    statusDiv.classList.remove('bg-blue-50', 'border-blue-200');
                    statusDiv.classList.add('bg-yellow-50', 'border-yellow-200');
                    statusText.className = 'text-sm text-yellow-800';
                    statusText.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ —Å –≤–∞–º–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.';
                    statusSpinner.classList.add('hidden');
                    statusCheck.classList.add('hidden');

                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 5000);
                } else {
                    statusDiv.classList.remove('bg-blue-50', 'border-blue-200');
                    statusDiv.classList.add('bg-green-50', 'border-green-200');
                    statusText.className = 'text-sm text-green-800';
                    statusText.textContent = `–ù–∞–π–¥–µ–Ω–æ ${myPhotos.length} —Ñ–æ—Ç–æ —Å –≤–∞–º–∏!`;
                    statusSpinner.classList.add('hidden');
                    statusCheck.classList.remove('hidden');

                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);

                    // –í–∫–ª—é—á–∏—Ç—å —á–µ–∫–±–æ–∫—Å "–§–æ—Ç–æ —Å–æ –º–Ω–æ–π"
                    const myPhotosCheckbox = document.getElementById('myPhotosOnly');
                    myPhotosCheckbox.disabled = false;
                    myPhotosCheckbox.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');

                    // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫
                    document.getElementById('myPhotosCount').textContent = `(${myPhotos.length})`;
                    document.getElementById('myPhotosCount').classList.remove('hidden');

                    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
                    renderFilters();
                    applyFilters();
                }

            } catch (error) {
                console.error('Error in face search:', error);
                statusDiv.classList.remove('bg-blue-50', 'border-blue-200');
                statusDiv.classList.add('bg-red-50', 'border-red-200');
                statusText.className = 'text-sm text-red-800';
                statusText.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                statusSpinner.classList.add('hidden');
                statusCheck.classList.add('hidden');

                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        async function handleSelfieUpload(file) {
            if (!file) return;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!file.type.match(/image\/(jpeg|jpg|png)/)) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JPG –∏–ª–∏ PNG');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 10 –ú–ë');
                return;
            }

            const supabase = window.portalSupabase;
            const currentUser = window.currentGuest;

            if (!supabase || !currentUser) {
                alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                return;
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
            const statusDiv = document.getElementById('searchStatus');
            const statusText = document.getElementById('searchStatusText');
            const statusSpinner = document.getElementById('searchStatusSpinner');
            const statusCheck = document.getElementById('searchStatusCheck');
            statusDiv.classList.remove('hidden');
            statusText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...';
            statusSpinner.classList.remove('hidden');
            statusCheck.classList.add('hidden');

            try {
                // 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–ª—Ñ–∏ –≤ Storage (–≤—Ä–µ–º–µ–Ω–Ω–æ)
                const fileName = `selfies/${currentUser.id}/${Date.now()}.${file.name.split('.').pop()}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('retreat-photos')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        contentType: file.type
                    });

                if (uploadError) throw uploadError;

                // 2. –ü–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π URL
                const { data: urlData } = supabase.storage
                    .from('retreat-photos')
                    .getPublicUrl(fileName);

                if (!urlData?.publicUrl) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL —Å–µ–ª—Ñ–∏');
                }

                // 3. –í—ã–∑–≤–∞—Ç—å Edge Function –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ç—Ä–∏—Ç–∞
                statusText.textContent = '–ü–æ–∏—Å–∫ –ª–∏—Ü...';
                statusSpinner.classList.remove('hidden');
                statusCheck.classList.add('hidden');

                const retreatIds = retreats.map(r => r.id);
                let allFoundPhotoIds = new Set();

                for (const retreatId of retreatIds) {
                    try {
                        const { data: searchResult, error: searchError } = await supabase.functions.invoke(
                            'search-face',
                            {
                                body: {
                                    retreat_id: retreatId,
                                    photo_url: urlData.publicUrl,
                                    vaishnava_id: currentUser.id,
                                    threshold: 80
                                }
                            }
                        );

                        if (searchError) {
                            console.error('Search error for retreat:', retreatId, searchError);
                            continue;
                        }

                        if (searchResult?.matched_photo_ids) {
                            searchResult.matched_photo_ids.forEach(id => allFoundPhotoIds.add(id));
                        }
                    } catch (err) {
                        console.error('Error searching retreat:', retreatId, err);
                    }
                }

                // 4. –£–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–µ–ª—Ñ–∏
                await supabase.storage.from('retreat-photos').remove([fileName]);

                // 5. –û–±–Ω–æ–≤–∏—Ç—å myPhotos –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                myPhotos = Array.from(allFoundPhotoIds);

                if (myPhotos.length === 0) {
                    statusDiv.classList.remove('bg-blue-50', 'border-blue-200');
                    statusDiv.classList.add('bg-yellow-50', 'border-yellow-200');
                    statusText.className = 'text-sm text-yellow-800';
                    statusText.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ —Å –≤–∞–º–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–∑–∂–µ.';
                    statusSpinner.classList.add('hidden');
                    statusCheck.classList.add('hidden');

                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 5000);
                } else {
                    statusDiv.classList.remove('bg-blue-50', 'border-blue-200');
                    statusDiv.classList.add('bg-green-50', 'border-green-200');
                    statusText.className = 'text-sm text-green-800';
                    statusText.textContent = `–ù–∞–π–¥–µ–Ω–æ ${myPhotos.length} —Ñ–æ—Ç–æ —Å –≤–∞–º–∏!`;
                    statusSpinner.classList.add('hidden');
                    statusCheck.classList.remove('hidden');

                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);

                    // –í–∫–ª—é—á–∏—Ç—å —á–µ–∫–±–æ–∫—Å "–§–æ—Ç–æ —Å–æ –º–Ω–æ–π"
                    const myPhotosCheckbox = document.getElementById('myPhotosOnly');
                    myPhotosCheckbox.disabled = false;
                    myPhotosCheckbox.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');

                    // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫
                    document.getElementById('myPhotosCount').textContent = `(${myPhotos.length})`;
                    document.getElementById('myPhotosCount').classList.remove('hidden');

                    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
                    renderFilters();
                    applyFilters();
                }

            } catch (error) {
                console.error('Error in face search:', error);
                statusDiv.classList.remove('bg-blue-50', 'border-blue-200');
                statusDiv.classList.add('bg-red-50', 'border-red-200');
                statusText.className = 'text-sm text-red-800';
                statusText.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                statusSpinner.classList.add('hidden');
                statusCheck.classList.add('hidden');

                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Event listeners for face search
        document.getElementById('findMeBtn').addEventListener('click', findMyPhotos);
        document.getElementById('selfieInput').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleSelfieUpload(e.target.files[0]);
                e.target.value = ''; // Reset –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            }
        });

        // Event listeners for selection
        document.getElementById('selectAllBtn').addEventListener('click', selectAllPhotos);
        document.getElementById('downloadSelectedBtn').addEventListener('click', downloadSelectedAsZip);

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const lightbox = document.getElementById('lightbox');
            if (!lightbox.classList.contains('active')) return;

            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') navigateLightbox(-1);
            if (e.key === 'ArrowRight') navigateLightbox(1);
        });

        // Close on background click
        document.getElementById('lightbox').addEventListener('click', (e) => {
            if (e.target.id === 'lightbox') closeLightbox();
        });

        // ==================== START ====================
        init();
    </script>

</body>
</html>
